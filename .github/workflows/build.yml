name: Build 18TRIP Tool

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# 【修复点 1】给机器人发通行证，允许它上传文件
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # 开始打包 (这一步很慢，大概10分钟，正常)
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          script-name: 18trip.py
          mode: onefile
          enable-plugins: tk-inter
          disable-console: true

      # 【修复点 2】双重保险：先上传到临时区 (Artifacts)
      # 这样就算 Release 失败了，你也能在页面底部下载到软件！
      - name: Upload Artifact (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: 18TRIP-Tool-Backup
          path: build/*.exe

      # 正式发布到 Release
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') == false # 只有不是标签触发时才运行，避免逻辑冲突
        with:
          files: build/*.exe
          tag_name: v${{ github.run_number }}
          name: "18TRIP Tool v${{ github.run_number }}"
          body: "18TRIP 字幕提取器 (V10 修正版)"
